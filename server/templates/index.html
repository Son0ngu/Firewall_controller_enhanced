{# filepath: c:\Users\sonbx\firewall-controller\server\templates\index.html #}
{% extends "base.html" %}

{% block title %}Dashboard - Firewall Controller{% endblock %}

{% block extra_css %}
<style>
    .log-table {
        font-size: 0.9rem;
    }
    .status-allow {
        color: #198754;
    }
    .status-block {
        color: #dc3545;
    }
    .highlight {
        animation: highlight-row 2s ease-in-out;
    }
    @keyframes highlight-row {
        0% { background-color: rgba(255, 248, 189, 0.8); }
        100% { background-color: transparent; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
            <div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Total Logs</h5>
                <p class="card-text display-4" id="totalLogs">{{ stats.total|default('0') }}</p>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="{{ url_for('logs.index') }}">View Details</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Allowed Access</h5>
                <p class="card-text display-4" id="allowedLogs">{{ stats.allowed|default('0') }}</p>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="{{ url_for('logs.index', action='allow') }}">View Details</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Blocked Access</h5>
                <p class="card-text display-4" id="blockedLogs">{{ stats.blocked|default('0') }}</p>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="{{ url_for('logs.index', action='block') }}">View Details</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Active Agents</h5>
                <p class="card-text display-4" id="activeAgents">{{ stats.active_agents|default('0') }}</p>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="{{ url_for('agents.index') }}">View Details</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="realTimeUpdates" checked>
                    <label class="form-check-label" for="realTimeUpdates">Real-time updates</label>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover log-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Agent</th>
                                <th>Domain</th>
                                <th>IP</th>
                                <th>Protocol</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            {% for log in recent_logs %}
                            <tr id="log-{{ log._id }}">
                                <td>{{ log.timestamp|format_datetime }}</td>
                                <td>{{ log.agent_hostname|default(log.agent_id) }}</td>
                                <td>{{ log.domain }}</td>
                                <td>{{ log.dest_ip }}</td>
                                <td>{{ log.protocol|default('HTTPS') }}</td>
                                <td>
                                    {% if log.action == 'allow' %}
                                    <span class="status-allow"><i class="fas fa-check-circle me-1"></i>Allowed</span>
                                    {% else %}
                                    <span class="status-block"><i class="fas fa-ban me-1"></i>Blocked</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary view-log-btn" 
                                                data-log-id="{{ log._id }}" data-bs-toggle="modal" data-bs-target="#logDetailModal">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if current_user.role == 'admin' %}
                                        <button type="button" class="btn btn-outline-danger delete-log-btn" data-log-id="{{ log._id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if not recent_logs %}
                <div class="text-center py-4" id="noLogsMessage">
                    <i class="fas fa-info-circle fa-2x mb-3 text-info"></i>
                    <p>No logs recorded yet. They will appear here as network activity is monitored.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent d-flex justify-content-between">
                <span>Showing last {{ recent_logs|length }} of {{ stats.total|default('0') }} logs</span>
                <a href="{{ url_for('logs.index') }}" class="btn btn-sm btn-outline-primary">View All Logs</a>
            </div>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailModalLabel">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="logDetailContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if current_user.role in ['admin', 'operator'] %}
                <button type="button" class="btn btn-primary" id="whitelistDomainBtn">Add to Whitelist</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filter Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label for="agentFilter" class="form-label">Agent</label>
                        <select class="form-select" id="agentFilter">
                            <option value="">All Agents</option>
                            {% for agent in agents %}
                            <option value="{{ agent.agent_id }}">{{ agent.hostname|default(agent.agent_id) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="actionFilter" class="form-label">Action</label>
                        <select class="form-select" id="actionFilter">
                            <option value="">All Actions</option>
                            <option value="allow">Allowed</option>
                            <option value="block">Blocked</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="domainFilter" class="form-label">Domain (contains)</label>
                        <input type="text" class="form-control" id="domainFilter" placeholder="e.g., example.com">
                    </div>
                    <div class="mb-3">
                        <label for="timeRangeFilter" class="form-label">Time Range</label>
                        <select class="form-select" id="timeRangeFilter">
                            <option value="1h">Last Hour</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="applyFilterBtn">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Connect to Socket.IO server
        const socket = io();
        let realTimeEnabled = true;
        
        // Toggle real-time updates
        document.getElementById('realTimeUpdates').addEventListener('change', function() {
            realTimeEnabled = this.checked;
        });
        
        // Handle new log events
        socket.on('new_log', function(data) {
            if (!realTimeEnabled) return;
            
            // Update counters
            updateCounters(data);
            
            // Add new log to table
            addLogToTable(data);
            
            // Show alert for blocked domains
            if (data.action === 'block') {
                showBlockAlert(data);
            }
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });
        
        // Apply filters
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            const agent = document.getElementById('agentFilter').value;
            const action = document.getElementById('actionFilter').value;
            const domain = document.getElementById('domainFilter').value;
            const timeRange = document.getElementById('timeRangeFilter').value;
            
            // Build query string
            let queryParams = [];
            if (agent) queryParams.push(`agent_id=${encodeURIComponent(agent)}`);
            if (action) queryParams.push(`action=${encodeURIComponent(action)}`);
            if (domain) queryParams.push(`domain=${encodeURIComponent(domain)}`);
            if (timeRange) queryParams.push(`time_range=${encodeURIComponent(timeRange)}`);
            
            // Redirect to filtered view
            window.location.href = `${window.location.pathname}?${queryParams.join('&')}`;
        });
        
        // View log details
        document.querySelectorAll('.view-log-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const logId = this.getAttribute('data-log-id');
                fetchLogDetails(logId);
            });
        });
        
        // Delete log
        document.querySelectorAll('.delete-log-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const logId = this.getAttribute('data-log-id');
                if (confirm('Are you sure you want to delete this log?')) {
                    deleteLog(logId);
                }
            });
        });
        
        // Add domain to whitelist
        document.getElementById('whitelistDomainBtn').addEventListener('click', function() {
            const domain = this.getAttribute('data-domain');
            if (domain) {
                addToWhitelist(domain);
            }
        });
        
        // Function to update dashboard counters
        function updateCounters(data) {
            const totalElement = document.getElementById('totalLogs');
            const allowedElement = document.getElementById('allowedLogs');
            const blockedElement = document.getElementById('blockedLogs');
            
            if (totalElement) {
                totalElement.textContent = (parseInt(totalElement.textContent) + 1).toString();
            }
            
            if (data.action === 'allow' && allowedElement) {
                allowedElement.textContent = (parseInt(allowedElement.textContent) + 1).toString();
            } else if (data.action === 'block' && blockedElement) {
                blockedElement.textContent = (parseInt(blockedElement.textContent) + 1).toString();
            }
        }
        
        // Function to add a new log to the table
        function addLogToTable(data) {
            const tableBody = document.getElementById('logsTableBody');
            const noLogsMessage = document.getElementById('noLogsMessage');
            
            if (noLogsMessage) {
                noLogsMessage.style.display = 'none';
            }
            
            // Format date
            const date = new Date(data.timestamp);
            const formattedDate = date.toLocaleString();
            
            // Create row
            const row = document.createElement('tr');
            row.id = `log-${data._id}`;
            row.className = 'highlight';
            
            // Status icon and class
            const statusIcon = data.action === 'allow' ? 
                '<span class="status-allow"><i class="fas fa-check-circle me-1"></i>Allowed</span>' : 
                '<span class="status-block"><i class="fas fa-ban me-1"></i>Blocked</span>';
            
            // Get agent name (hostname or ID)
            const agentName = data.agent_hostname || data.agent_id;
            
            // Actions buttons
            const isAdmin = {{ 'true' if current_user.role == 'admin' else 'false' }};
            const actions = `
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary view-log-btn" 
                            data-log-id="${data._id}" data-bs-toggle="modal" data-bs-target="#logDetailModal">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${isAdmin ? `
                    <button type="button" class="btn btn-outline-danger delete-log-btn" data-log-id="${data._id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    ` : ''}
                </div>
            `;
            
            // Set row content
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${agentName}</td>
                <td>${data.domain}</td>
                <td>${data.dest_ip}</td>
                <td>${data.protocol || 'HTTPS'}</td>
                <td>${statusIcon}</td>
                <td>${actions}</td>
            `;
            
            // Insert at the beginning of the table
            if (tableBody.firstChild) {
                tableBody.insertBefore(row, tableBody.firstChild);
            } else {
                tableBody.appendChild(row);
            }
            
            // Add event listeners to the new buttons
            const viewBtn = row.querySelector('.view-log-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function() {
                    fetchLogDetails(data._id);
                });
            }
            
            const deleteBtn = row.querySelector('.delete-log-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this log?')) {
                        deleteLog(data._id);
                    }
                });
            }
            
            // Remove oldest row if we have more than 50
            const rows = tableBody.querySelectorAll('tr');
            if (rows.length > 50) {
                tableBody.removeChild(rows[rows.length - 1]);
            }
        }
        
        // Function to show alert for blocked domains
        function showBlockAlert(data) {
            const alertContainer = document.getElementById('liveAlertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <strong>Access Blocked!</strong> Connection to <b>${data.domain}</b> was blocked.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Function to fetch log details
        function fetchLogDetails(logId) {
            const contentDiv = document.getElementById('logDetailContent');
            const whitelistBtn = document.getElementById('whitelistDomainBtn');
            
            // Show loading spinner
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            // Fetch log details
            fetch(`/api/logs/${logId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        contentDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    // Format date
                    const date = new Date(data.timestamp);
                    const formattedDate = date.toLocaleString();
                    
                    // Set domain for whitelist button
                    whitelistBtn.setAttribute('data-domain', data.domain);
                    
                    // Build details HTML
                    let detailsHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Basic Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-4">Time</dt>
                                    <dd class="col-sm-8">${formattedDate}</dd>
                                    
                                    <dt class="col-sm-4">Domain</dt>
                                    <dd class="col-sm-8">${data.domain}</dd>
                                    
                                    <dt class="col-sm-4">IP Address</dt>
                                    <dd class="col-sm-8">${data.dest_ip}</dd>
                                    
                                    <dt class="col-sm-4">Protocol</dt>
                                    <dd class="col-sm-8">${data.protocol || 'HTTPS'}</dd>
                                    
                                    <dt class="col-sm-4">Port</dt>
                                    <dd class="col-sm-8">${data.dest_port || '443'}</dd>
                                    
                                    <dt class="col-sm-4">Action</dt>
                                    <dd class="col-sm-8">
                                        ${data.action === 'allow' ? 
                                        '<span class="text-success">Allowed</span>' : 
                                        '<span class="text-danger">Blocked</span>'}
                                    </dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6>Agent Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-4">Agent ID</dt>
                                    <dd class="col-sm-8">${data.agent_id}</dd>
                                    
                                    <dt class="col-sm-4">Hostname</dt>
                                    <dd class="col-sm-8">${data.agent_hostname || 'N/A'}</dd>
                                    
                                    ${data.process_name ? `
                                    <dt class="col-sm-4">Process</dt>
                                    <dd class="col-sm-8">${data.process_name}</dd>
                                    ` : ''}
                                </dl>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6>Raw Data</h6>
                        <pre class="bg-light p-3 rounded"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    `;
                    
                    contentDiv.innerHTML = detailsHtml;
                })
                .catch(error => {
                    contentDiv.innerHTML = `<div class="alert alert-danger">Error loading log details: ${error.message}</div>`;
                });
        }
        
        // Function to delete a log
        function deleteLog(logId) {
            fetch(`/api/logs/${logId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                // Remove row from table
                const row = document.getElementById(`log-${logId}`);
                if (row) {
                    row.remove();
                }
                
                // Show success message
                const alertContainer = document.getElementById('liveAlertContainer');
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Log entry has been deleted.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                alertContainer.appendChild(alertDiv);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            })
            .catch(error => {
                alert(`Error deleting log: ${error.message}`);
            });
        }
        
        // Function to add domain to whitelist
        function addToWhitelist(domain) {
            fetch('/api/whitelist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    domain: domain,
                    notes: 'Added from dashboard'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                // Show success message
                const alertContainer = document.getElementById('liveAlertContainer');
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Domain <b>${domain}</b> has been added to the whitelist.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                alertContainer.appendChild(alertDiv);
                
                // Remove alert after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('logDetailModal'));
                modal.hide();
            })
            .catch(error => {
                alert(`Error adding to whitelist: ${error.message}`);
            });
        }
    });
</script>
{% endblock %}