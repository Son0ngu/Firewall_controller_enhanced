{# filepath: c:\Users\sonbx\firewall-controller\server\templates\logs.html #}
{% extends "base.html" %}

{% block title %}System Logs - Firewall Controller{% endblock %}

{% block extra_css %}
<style>
    .log-entry {
        transition: background-color 0.2s;
    }
    .log-entry:hover {
        background-color: #f8f9fa;
    }
    .log-level-info {
        color: #17a2b8;
    }
    .log-level-warning {
        color: #ffc107;
    }
    .log-level-error {
        color: #dc3545;
    }
    .log-level-success {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-file-alt me-2"></i>System Logs
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>Clear Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Total Logs
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalLogsCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-list fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Allowed Requests
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="allowedCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Blocked Requests
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="blockedCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-ban fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Errors
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="errorCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="filterLogs('all')">All</button>
                        <button type="button" class="btn btn-outline-success" onclick="filterLogs('allow')">Allowed</button>
                        <button type="button" class="btn btn-outline-danger" onclick="filterLogs('block')">Blocked</button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterLogs('error')">Errors</button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="logsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading logs...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading system logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let logsData = [];
let currentFilter = 'all';

// Format timestamp function
function formatTimestamp(isoString, includeTimezone = false) {
    if (!isoString) return 'Never';
    
    try {
        const date = new Date(isoString);
        
        if (includeTimezone) {
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
        } else {
            return date.toLocaleString();
        }
    } catch (e) {
        return 'Invalid Date';
    }
}

// Create log row
function createLogRow(log) {
    const timestamp = formatTimestamp(log.timestamp);
    const domain = log.domain || log.url || 'N/A';
    const agent = log.agent_hostname || log.agent_id || 'System';
    
    // Determine action and styling
    let actionClass = 'secondary';
    let actionText = 'UNKNOWN';
    
    if (log.action) {
        switch (log.action.toLowerCase()) {
            case 'allow':
            case 'allowed':
                actionClass = 'success';
                actionText = 'ALLOWED';
                break;
            case 'block':
            case 'blocked':
                actionClass = 'danger';
                actionText = 'BLOCKED';
                break;
            case 'warn':
            case 'warning':
                actionClass = 'warning';
                actionText = 'WARNING';
                break;
        }
    }
    
    const actionBadge = `<span class="badge bg-${actionClass}">${actionText}</span>`;
    
    // Build details
    let details = [];
    if (log.dest_ip) details.push(`IP: ${log.dest_ip}`);
    if (log.dest_port) details.push(`Port: ${log.dest_port}`);
    if (log.protocol) details.push(`Protocol: ${log.protocol}`);
    
    return `
        <tr class="log-entry">
            <td title="${formatTimestamp(log.timestamp, true)}">
                <small>${timestamp}</small>
            </td>
            <td>${domain}</td>
            <td><small>${agent}</small></td>
            <td>${actionBadge}</td>
            <td><small class="text-muted">${details.join(' | ')}</small></td>
        </tr>
    `;
}

// Load logs
async function loadLogs() {
    console.log('üîÑ Loading logs...');
    
    try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        
        console.log('üìä Logs response:', data);
        
        if (data.success && data.logs) {
            logsData = data.logs;
            renderLogsTable(logsData);
            updateLogStatistics(data);
        } else {
            console.error('‚ùå Invalid logs response:', data);
            showLogsError('Failed to load logs');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading logs:', error);
        showLogsError('Network error loading logs');
    }
}

// Render logs table
function renderLogsTable(logs) {
    const container = document.getElementById('logsContainer');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">No logs found</p>
            </div>
        `;
        return;
    }
    
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="logsTable">
                <thead class="table-light">
                    <tr>
                        <th>Timestamp</th>
                        <th>Domain</th>
                        <th>Agent</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    ${logs.map(log => createLogRow(log)).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHtml;
}

// Update log statistics
function updateLogStatistics(data) {
    // You can get these from logs summary endpoint
    document.getElementById('totalLogsCount').textContent = data.total || '0';
    
    // Count by action
    const logs = data.logs || [];
    const allowedCount = logs.filter(log => log.action === 'allow').length;
    const blockedCount = logs.filter(log => log.action === 'block').length;
    const errorCount = logs.filter(log => log.level === 'error').length;
    
    document.getElementById('allowedCount').textContent = allowedCount;
    document.getElementById('blockedCount').textContent = blockedCount;
    document.getElementById('errorCount').textContent = errorCount;
}

// Show logs error
function showLogsError(message) {
    const container = document.getElementById('logsContainer');
    container.innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <p class="text-danger">${message}</p>
            <button class="btn btn-outline-primary" onclick="loadLogs()">
                <i class="fas fa-redo me-1"></i>Retry
            </button>
        </div>
    `;
}

// Filter logs
function filterLogs(action) {
    currentFilter = action;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter logs
    let filteredLogs = logsData;
    if (action !== 'all') {
        filteredLogs = logsData.filter(log => log.action === action);
    }
    
    renderLogsTable(filteredLogs);
}

// Refresh logs
function refreshLogs() {
    loadLogs();
}

// Clear logs
async function clearLogs() {
    if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/logs', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Successfully cleared ${result.deleted_count} logs`);
            loadLogs(); // Reload logs
        } else {
            alert('Failed to clear logs: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error clearing logs:', error);
        alert('Network error clearing logs');
    }
}

// Load logs when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    setInterval(loadLogs, 30000);  // Auto-refresh every 30 seconds
});
</script>
{% endblock %}