{# filepath: c:\Users\sonbx\firewall-controller\server\templates\admin.html #}
{% extends "base.html" %}

{% block title %}Admin Dashboard - Firewall Controller{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4 mb-3">Firewall Monitoring Dashboard</h1>
    
    <!-- Thống kê tổng quan -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Logs</h5>
                    <h2 id="total-logs">Loading...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Allowed Connections</h5>
                    <h2 id="allowed-logs">Loading...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Blocked Connections</h5>
                    <h2 id="blocked-logs">Loading...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Active Agents</h5>
                    <h2 id="active-agents">Loading...</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bảng log mới nhất -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Recent Logs</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="logs-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Agent</th>
                            <th>Domain</th>
                            <th>IP</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <tr>
                            <td colspan="5" class="text-center">Loading logs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Khởi tạo Socket.IO
    const socket = io();

    // Khi nhận được log mới từ server
    socket.on('new_log', function(log) {
        // Thêm log vào bảng
        addLogToTable(log);
        
        // Cập nhật số liệu thống kê
        updateCounters();
    });

    // Khi kết nối thành công
    socket.on('connect', function() {
        console.log('Connected to server');
        
        // Lấy log và thống kê ban đầu
        loadInitialData();
    });

    // Lấy log và thống kê ban đầu
    function loadInitialData() {
        // Lấy log gần đây nhất
        fetch('/api/logs?limit=50')
            .then(response => response.json())
            .then(data => {
                // Xóa dòng "Loading..."
                document.getElementById('logs-body').innerHTML = '';
                
                // Thêm log vào bảng
                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => addLogToTable(log, true));
                } else {
                    document.getElementById('logs-body').innerHTML = 
                        '<tr><td colspan="5" class="text-center">No logs available</td></tr>';
                }
            })
            .catch(error => console.error('Error loading logs:', error));
        
        // Lấy thống kê tổng quan
        fetch('/api/logs/summary')
            .then(response => response.json())
            .then(data => {
                // Cập nhật bộ đếm
                document.getElementById('total-logs').textContent = data.total_logs || 0;
                document.getElementById('allowed-logs').textContent = data.actions?.allow || 0;
                document.getElementById('blocked-logs').textContent = data.actions?.block || 0;
                document.getElementById('active-agents').textContent = data.agents?.length || 0;
            })
            .catch(error => console.error('Error loading summary:', error));
    }

    // Thêm log mới vào bảng
    function addLogToTable(log, prepend = false) {
        const tbody = document.getElementById('logs-body');
        
        // Tạo dòng mới
        const row = document.createElement('tr');
        
        // Thêm class dựa vào action
        if (log.action === 'block') {
            row.className = 'table-danger';
        } else if (log.action === 'allow') {
            row.className = 'table-success';
        }
        
        // Format timestamp
        const timestamp = new Date(log.timestamp).toLocaleString();
        
        // Đặt nội dung cho dòng
        row.innerHTML = `
            <td>${timestamp}</td>
            <td>${log.agent_id}</td>
            <td>${log.domain}</td>
            <td>${log.dest_ip || '-'}</td>
            <td><span class="badge ${log.action === 'block' ? 'bg-danger' : 'bg-success'}">${log.action || 'unknown'}</span></td>
        `;
        
        // Thêm dòng vào đầu hoặc cuối bảng
        if (prepend) {
            // Thêm vào đầu bảng
            if (tbody.firstChild) {
                tbody.insertBefore(row, tbody.firstChild);
            } else {
                tbody.appendChild(row);
            }
        } else {
            // Thêm vào cuối bảng
            tbody.appendChild(row);
            
            // Giữ bảng không quá dài
            while (tbody.children.length > 50) {
                tbody.removeChild(tbody.lastChild);
            }
        }
    }

    // Cập nhật bộ đếm
    function updateCounters() {
        fetch('/api/logs/summary')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-logs').textContent = data.total_logs || 0;
                document.getElementById('allowed-logs').textContent = data.actions?.allow || 0;
                document.getElementById('blocked-logs').textContent = data.actions?.block || 0;
                document.getElementById('active-agents').textContent = data.agents?.length || 0;
            })
            .catch(error => console.error('Error updating counters:', error));
    }
</script>
{% endblock %}