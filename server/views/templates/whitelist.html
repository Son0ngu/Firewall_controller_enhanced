{% extends "base.html" %}

{% block title %}Whitelist Management - Firewall Controller{% endblock %}

{% block extra_css %}
<style>
    .domain-card {
        transition: transform 0.2s;
    }
    .domain-card:hover {
        transform: translateY(-2px);
    }
    .domain-item {
        border-left: 4px solid #007bff;
        background: #f8f9fa;
    }
    .domain-item.manual {
        border-left-color: #28a745;
    }
    .domain-item.system {
        border-left-color: #6c757d;
    }
    .domain-actions {
        opacity: 0;
        transition: opacity 0.2s;
    }
    .domain-item:hover .domain-actions {
        opacity: 1;
    }
    
    /* âœ… Simple White Clock Widget */
    .clock-widget {
        background: white;
        color: #333;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .clock-time {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 8px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #2c3e50;
    }
    
    .clock-date {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .clock-timezone {
        font-size: 0.75rem;
        color: #adb5bd;
        font-weight: 500;
    }
    
    .clock-icon {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1rem;
        color: #dee2e6;
    }
    
    /* âœ… Hover effect for subtle interaction */
    .clock-widget:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transition: box-shadow 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-list me-2"></i>
                Whitelist Management
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshWhitelist()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDomainModal">
                    <i class="fas fa-plus me-1"></i>Add Domain
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Whitelist Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Total Domains
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDomainsCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-list fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Manual Entries
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="manualDomainsCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-edit fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-start-secondary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                            System Entries
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="systemDomainsCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-cog fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- âœ… Clock Widget -->
    <div class="col-xl-3 col-md-6">
        <div class="clock-widget">
            <i class="fas fa-clock clock-icon"></i>
            <div class="clock-time" id="currentTime">--:--:--</div>
            <div class="clock-date" id="currentDate">Loading...</div>
            <div class="clock-timezone">UTC+7 (Ho Chi Minh)</div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search Domains</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search domains..." onkeyup="filterDomains()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="sourceFilter" class="form-label">Source</label>
                        <select class="form-select" id="sourceFilter" onchange="filterDomains()">
                            <option value="">All Sources</option>
                            <option value="manual">Manual</option>
                            <option value="system">System</option>
                            <option value="imported">Imported</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sortSelect" class="form-label">Sort By</label>
                        <select class="form-select" id="sortSelect" onchange="sortDomains()">
                            <option value="domain">Domain Name</option>
                            <option value="added_date">Date Added</option>
                            <option value="added_by">Added By</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="row mb-3" id="bulkActionsRow" style="display: none;">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-check-square me-2"></i>
                        <span id="selectedCount">0</span> domains selected
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
                            <i class="fas fa-trash me-1"></i>Delete Selected
                        </button>
            
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                            <i class="fas fa-times me-1"></i>Clear Selection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Domains List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>Whitelisted Domains
                    </h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label class="form-check-label" for="selectAll">
                            Select All
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="domainsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading domains...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading whitelist...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Domain Modal - Updated with correct field names -->
<div class="modal fade" id="addDomainModal" tabindex="-1" aria-labelledby="addDomainModalLabel" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDomainModalLabel">
                    <i class="fas fa-plus me-2"></i>Add Entry to Whitelist
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addDomainForm" onsubmit="addEntry(event)" novalidate>
                <div class="modal-body">
                    <!-- Entry Type Selection -->
                    <div class="mb-4">
                        <label class="form-label">Entry Type *</label>
                        <div class="row">
                            <div class="col-6 col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="entryType" id="typeDomain" value="domain" checked onchange="updateEntryForm()">
                                    <label class="form-check-label" for="typeDomain">
                                        <i class="fas fa-globe me-1"></i>Domain
                                    </label>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="entryType" id="typeIP" value="ip" onchange="updateEntryForm()">
                                    <label class="form-check-label" for="typeIP">
                                        <i class="fas fa-network-wired me-1"></i>IP
                                    </label>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="entryType" id="typeURL" value="url" onchange="updateEntryForm()">
                                    <label class="form-check-label" for="typeURL">
                                        <i class="fas fa-link me-1"></i>URL
                                    </label>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="entryType" id="typePattern" value="pattern" onchange="updateEntryForm()">
                                    <label class="form-check-label" for="typePattern">
                                        <i class="fas fa-code me-1"></i>Pattern
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- âœ… Domain Form -->
                    <div id="domainForm" class="entry-form">
                        <div class="mb-3">
                            <label for="domainInput" class="form-label">Domain Name *</label>
                            <input type="text" class="form-control" id="domainInput" name="domainValue" 
                                   placeholder="example.com" 
                                   pattern="^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*$">
                            <div class="form-text">
                                Examples: google.com, firewall-controller-vu7f.onrender.com, api.github.com
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid domain name.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeSubdomains" name="includeSubdomains">
                                <label class="form-check-label" for="includeSubdomains">
                                    Include all subdomains (*.domain.com)
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Examples:</strong><br>
                            â€¢ google.com<br>
                            â€¢ firewall-controller-vu7f.onrender.com<br>
                            â€¢ *.microsoft.com<br>
                            â€¢ api.github.com
                        </div>
                    </div>

                    <!-- âœ… IP Form -->
                    <div id="ipForm" class="entry-form" style="display: none;">
                        <div class="mb-3">
                            <label for="ipInput" class="form-label">IP Address *</label>
                            <input type="text" class="form-control" id="ipInput" name="ipValue" 
                                   placeholder="192.168.1.1">
                            <div class="form-text">IPv4, IPv6, or CIDR notation supported</div>
                            <div class="invalid-feedback">
                                Please enter a valid IP address.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="portInput" class="form-label">Port (Optional)</label>
                            <input type="number" class="form-control" id="portInput" name="portValue" 
                                   placeholder="80" min="1" max="65535">
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Examples:</strong><br>
                            â€¢ 192.168.1.1<br>
                            â€¢ 127.0.0.1:5000<br>
                            â€¢ 192.168.0.0/24<br>
                            â€¢ 2001:db8::1
                        </div>
                    </div>

                    <!-- âœ… URL Form - Fixed validation -->
                    <div id="urlForm" class="entry-form" style="display: none;">
                        <div class="mb-3">
                            <label for="urlInput" class="form-label">URL *</label>
                            <input type="text" class="form-control" id="urlInput" name="urlValue" 
                                   placeholder="https://api.example.com/v1/*">
                            <div class="form-text">Full URL with protocol (wildcards supported in path)</div>
                            <div class="invalid-feedback">
                                Please enter a valid URL.
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Examples:</strong><br>
                            â€¢ https://firewall-controller-vu7f.onrender.com<br>
                            â€¢ http://localhost:5000<br>
                            â€¢ https://api.github.com/*<br>
                            â€¢ https://fonts.googleapis.com/css
                        </div>
                    </div>

                    <!-- âœ… Pattern Form -->
                    <div id="patternForm" class="entry-form" style="display: none;">
                        <div class="mb-3">
                            <label for="patternInput" class="form-label">Pattern *</label>
                            <input type="text" class="form-control" id="patternInput" name="patternValue" 
                                   placeholder="*.example.*">
                            <div class="form-text">Pattern for advanced matching</div>
                            <div class="invalid-feedback">
                                Please enter a valid pattern.
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Advanced:</strong> Use patterns for complex matching rules
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categorySelect" class="form-label">Category</label>
                                <select class="form-select" id="categorySelect" name="category">
                                    <option value="uncategorized">Uncategorized</option>
                                    <option value="business">Business</option>
                                    <option value="development">Development</option>
                                    <option value="api">API Services</option>
                                    <option value="cdn">CDN/Resources</option>
                                    <option value="cloud">Cloud Services</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prioritySelect" class="form-label">Priority</label>
                                <select class="form-select" id="prioritySelect" name="priority">
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notesInput" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notesInput" name="notes" rows="2" 
                                  placeholder="Add any additional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info me-2" onclick="testEntry()">
                        <i class="fas fa-vial me-1"></i>Test Entry
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Add to Whitelist
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Domain Details Modal -->
<div class="modal fade" id="domainDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Domain Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="domainDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="deleteDomainBtn" onclick="deleteDomain()">
                    <i class="fas fa-trash me-1"></i>Delete Domain
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let whitelistData = [];
let selectedDomains = new Set();
let clockInterval = null;

// âœ… Clock functionality for UTC+7
function updateClock() {
    try {
        // Create date in UTC+7 (Ho Chi Minh timezone)
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const utcPlus7 = new Date(utc + (7 * 3600000)); // UTC+7
        
        // Format time (24-hour format)
        const hours = utcPlus7.getHours().toString().padStart(2, '0');
        const minutes = utcPlus7.getMinutes().toString().padStart(2, '0');
        const seconds = utcPlus7.getSeconds().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}:${seconds}`;
        
        // Format date
        const options = { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric'
        };
        const dateString = utcPlus7.toLocaleDateString('en-US', options);
        
        // Update DOM elements
        const timeElement = document.getElementById('currentTime');
        const dateElement = document.getElementById('currentDate');
        
        if (timeElement) timeElement.textContent = timeString;
        if (dateElement) dateElement.textContent = dateString;
        
    } catch (error) {
        console.error('Error updating clock:', error);
        // Fallback to simple time display
        const now = new Date();
        const timeElement = document.getElementById('currentTime');
        const dateElement = document.getElementById('currentDate');
        if (timeElement) timeElement.textContent = now.toLocaleTimeString();
        if (dateElement) dateElement.textContent = now.toLocaleDateString();
    }
}

function startClock() {
    // Update immediately
    updateClock();
    
    // Update every second
    if (clockInterval) {
        clearInterval(clockInterval);
    }
    clockInterval = setInterval(updateClock, 1000);
}

function stopClock() {
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }
}

// âœ… Enhanced updateEntryForm function
function updateEntryForm() {
    const selectedType = document.querySelector('input[name="entryType"]:checked')?.value || 'domain';
    
    // Hide all forms first
    document.querySelectorAll('.entry-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Clear all validation states and requirements
    document.querySelectorAll('.form-control').forEach(input => {
        input.setCustomValidity('');
        input.classList.remove('is-invalid', 'is-valid');
        input.removeAttribute('required');
        input.removeAttribute('pattern');
        input.type = input.id.includes('url') ? 'text' : input.type; // Fix URL input type
    });
    
    // Show selected form and set validation
    switch (selectedType) {
        case 'domain':
            document.getElementById('domainForm').style.display = 'block';
            document.getElementById('domainInput').setAttribute('required', 'required');
            break;
        case 'ip':
            document.getElementById('ipForm').style.display = 'block';
            document.getElementById('ipInput').setAttribute('required', 'required');
            break;
        case 'url':
            document.getElementById('urlForm').style.display = 'block';
            const urlInput = document.getElementById('urlInput');
            urlInput.setAttribute('required', 'required');
            urlInput.type = 'text'; // Use text instead of url for better flexibility
            break;
        case 'pattern':
            document.getElementById('patternForm').style.display = 'block';
            document.getElementById('patternInput').setAttribute('required', 'required');
            break;
    }
}

// âœ… Enhanced validation functions
function isValidDomain(domain) {
    // Allow wildcard domains
    if (domain.startsWith('*.')) {
        domain = domain.substring(2);
    }
    
    // Basic domain validation - more flexible
    const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*$/;
    return domainRegex.test(domain) && domain.length <= 253 && domain.length > 0;
}

function isValidIP(ip) {
    // IPv4 validation
    const ipv4Regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    if (ipv4Regex.test(ip)) return true;
    
    // IPv6 validation (simplified)
    const ipv6Regex = /^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;
    if (ipv6Regex.test(ip)) return true;
    
    // CIDR notation
    if (ip.includes('/')) {
        const parts = ip.split('/');
        if (parts.length === 2) {
            const cidr = parseInt(parts[1]);
            return isValidIP(parts[0]) && cidr >= 0 && cidr <= 32;
        }
    }
    
    return false;
}

function isValidURL(url) {
    // More flexible URL validation
    try {
        // Handle wildcards by replacing them temporarily
        const testUrl = url.replace(/\*/g, 'test');
        
        // Check for basic URL structure
        if (testUrl.includes('://')) {
            const urlObj = new URL(testUrl);
            return ['http:', 'https:'].includes(urlObj.protocol);
        }
        
        // Allow partial URLs that start with protocol
        if (url.startsWith('http://') || url.startsWith('https://')) {
            return url.length > 8; // More than just protocol
        }
        
        return false;
    } catch (e) {
        return false;
    }
}

function isValidPattern(pattern) {
    return pattern && pattern.trim().length > 0;
}

function showValidationError(inputId, message) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    input.classList.add('is-invalid');
    input.classList.remove('is-valid');
    
    // Update or create feedback element
    let feedback = input.parentNode.querySelector('.invalid-feedback');
    if (feedback) {
        feedback.textContent = message;
    }
}

function showValidationSuccess(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    input.classList.add('is-valid');
    input.classList.remove('is-invalid');
}

// âœ… Enhanced addEntry function
async function addEntry(event) {
    event.preventDefault();
    
    const form = event.target;
    const entryType = document.querySelector('input[name="entryType"]:checked')?.value || 'domain';
    
    // Get and validate value based on type
    let value = '';
    let isValid = true;
    
    switch (entryType) {
        case 'domain':
            value = document.getElementById('domainInput').value.trim().toLowerCase();
            if (!value) {
                showValidationError('domainInput', 'Domain name is required');
                isValid = false;
            } else if (!isValidDomain(value)) {
                showValidationError('domainInput', 'Please enter a valid domain name');
                isValid = false;
            } else {
                // Add wildcard if requested
                const includeSubdomains = document.getElementById('includeSubdomains')?.checked;
                if (includeSubdomains && !value.startsWith('*.')) {
                    value = '*.' + value;
                }
                showValidationSuccess('domainInput');
            }
            break;
            
        case 'ip':
            value = document.getElementById('ipInput').value.trim();
            if (!value) {
                showValidationError('ipInput', 'IP address is required');
                isValid = false;
            } else if (!isValidIP(value)) {
                showValidationError('ipInput', 'Please enter a valid IP address');
                isValid = false;
            } else {
                // Add port if specified
                const port = document.getElementById('portInput')?.value;
                if (port && port.trim()) {
                    const portNum = parseInt(port);
                    if (portNum < 1 || portNum > 65535) {
                        showValidationError('portInput', 'Port must be between 1 and 65535');
                        isValid = false;
                    } else {
                        value += ':' + port.trim();
                    }
                }
                if (isValid) {
                    showValidationSuccess('ipInput');
                }
            }
            break;
            
        case 'url':
            value = document.getElementById('urlInput').value.trim();
            if (!value) {
                showValidationError('urlInput', 'URL is required');
                isValid = false;
            } else if (!isValidURL(value)) {
                showValidationError('urlInput', 'Please enter a valid URL (must include http:// or https://)');
                isValid = false;
            } else {
                showValidationSuccess('urlInput');
            }
            break;
            
        case 'pattern':
            value = document.getElementById('patternInput').value.trim();
            if (!value) {
                showValidationError('patternInput', 'Pattern is required');
                isValid = false;
            } else if (!isValidPattern(value)) {
                showValidationError('patternInput', 'Please enter a valid pattern');
                isValid = false;
            } else {
                showValidationSuccess('patternInput');
            }
            break;
    }
    
    if (!isValid) {
        showNotification('danger', 'Please fix the validation errors before submitting');
        return;
    }
    
    // Get other form data
    const notes = document.getElementById('notesInput').value.trim();
    const category = document.getElementById('categorySelect').value;
    const priority = document.getElementById('prioritySelect').value;
    
    const requestData = {
        type: entryType,
        value: value,
        notes: notes || undefined,
        category: category || 'uncategorized',
        priority: priority || 'normal'
    };
    
    try {
        showNotification('info', `Adding ${entryType} "${value}" to whitelist...`);
        
        const response = await fetch('/api/whitelist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || `HTTP ${response.status}`);
        }
        
        showNotification('success', `âœ… ${entryType.charAt(0).toUpperCase() + entryType.slice(1)} "${value}" added to whitelist`);
        
        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('addDomainModal'));
        modal.hide();
        
        form.reset();
        updateEntryForm(); // Reset form visibility
        
        await refreshWhitelist();
        
    } catch (error) {
        console.error('Error adding entry:', error);
        showNotification('danger', 'Failed to add entry: ' + error.message);
    }
}

// âœ… Enhanced test function
async function testEntry() {
    const entryType = document.querySelector('input[name="entryType"]:checked')?.value || 'domain';
    
    let value = '';
    let isValid = true;
    
    switch (entryType) {
        case 'domain':
            value = document.getElementById('domainInput').value.trim().toLowerCase();
            if (!value || !isValidDomain(value)) {
                showNotification('warning', 'Please enter a valid domain to test');
                return;
            }
            break;
        case 'ip':
            value = document.getElementById('ipInput').value.trim();
            const port = document.getElementById('portInput')?.value;
            if (port && port.trim()) {
                value += ':' + port.trim();
            }
            if (!value || !isValidIP(value.split(':')[0])) {
                showNotification('warning', 'Please enter a valid IP address to test');
                return;
            }
            break;
        case 'url':
            value = document.getElementById('urlInput').value.trim();
            if (!value || !isValidURL(value)) {
                showNotification('warning', 'Please enter a valid URL to test');
                return;
            }
            break;
        case 'pattern':
            value = document.getElementById('patternInput').value.trim();
            if (!value || !isValidPattern(value)) {
                showNotification('warning', 'Please enter a valid pattern to test');
                return;
            }
            break;
    }
    
    try {
        showNotification('info', `Testing ${entryType} "${value}"...`);
        
        const response = await fetch('/api/whitelist/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: entryType,
                value: value,
                dns_verify: entryType === 'domain'
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showNotification('danger', 'Test failed: ' + data.error);
        } else {
            let message = `âœ… ${entryType} "${value}" is valid`;
            
            if (data.dns_info && data.dns_info.length > 0) {
                message += '\nðŸ“ DNS: ' + data.dns_info.join(', ');
            }
            
            if (data.reachable !== undefined) {
                message += data.reachable ? '\nðŸŒ Reachable' : '\nâŒ Not reachable';
            }
            
            if (data.additional_info) {
                message += '\nâ„¹ï¸ ' + data.additional_info;
            }
            
            showNotification('success', message);
        }
        
    } catch (error) {
        console.error('Error testing entry:', error);
        showNotification('danger', 'Test failed: ' + error.message);
    }
}

// âœ… Modal event handlers for better UX
document.addEventListener('DOMContentLoaded', function() {
    const addModal = document.getElementById('addDomainModal');
    if (addModal) {
        // When modal is shown
        addModal.addEventListener('shown.bs.modal', function() {
            updateEntryForm();
            // Focus first input after a short delay
            setTimeout(() => {
                const firstInput = addModal.querySelector('input[required]');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 150);
        });
        
        // When modal is hidden
        addModal.addEventListener('hidden.bs.modal', function() {
            // Clear form and validation states
            const form = document.getElementById('addDomainForm');
            if (form) {
                form.reset();
                form.querySelectorAll('.form-control').forEach(input => {
                    input.classList.remove('is-invalid', 'is-valid');
                    input.setCustomValidity('');
                });
            }
            updateEntryForm(); // Reset to default state
        });
        
        // Remove aria-hidden when modal is shown to fix accessibility
        addModal.addEventListener('show.bs.modal', function() {
            this.removeAttribute('aria-hidden');
        });
        
        // Add aria-hidden when modal is hidden
        addModal.addEventListener('hide.bs.modal', function() {
            this.setAttribute('aria-hidden', 'true');
        });
    }
});

// Load whitelist data
async function loadWhitelist() {
    try {
        const response = await fetch('/api/whitelist');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Received whitelist data:', data);
        
        // Handle different response formats
        let domains = [];
        if (data.domains && Array.isArray(data.domains)) {
            domains = data.domains;
        } else if (Array.isArray(data)) {
            domains = data;
        } else {
            console.error('Unexpected data format:', data);
            domains = [];
        }
        
        whitelistData = domains;
        updateStatistics();
        renderDomains(whitelistData);
        
    } catch (error) {
        console.error('Error loading whitelist:', error);
        showNotification('danger', 'Failed to load whitelist: ' + error.message);
        
        // Show empty state
        whitelistData = [];
        updateStatistics();
        renderDomains([]);
    }
}

// âœ… Format timestamp function
function formatTimestamp(isoString, includeTimezone = false) {
    if (!isoString) return 'Never';
    
    try {
        const date = new Date(isoString);
        
        if (isNaN(date.getTime())) {
            return 'Invalid Date';
        }
        
        if (includeTimezone) {
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
        } else {
            return date.toLocaleString();
        }
    } catch (e) {
        return 'Invalid Date';
    }
}

// âœ… FIX: Update statistics vá»›i null checks
function updateStatistics() {
    try {
        const total = whitelistData.length;
        const manual = whitelistData.filter(d => d.added_by && d.added_by !== 'system').length;
        const system = whitelistData.filter(d => d.added_by === 'system').length;
        
        // Safe update vá»›i null checks
        const totalElement = document.getElementById('totalDomainsCount');
        const manualElement = document.getElementById('manualDomainsCount'); 
        const systemElement = document.getElementById('systemDomainsCount');
        
        if (totalElement) totalElement.textContent = total;
        if (manualElement) manualElement.textContent = manual;
        if (systemElement) systemElement.textContent = system;
        
        console.log(`Statistics updated: Total=${total}, Manual=${manual}, System=${system}`);
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// âœ… Render domains
function renderDomains(domains) {
    const container = document.getElementById('domainsContainer');
    
    if (!container) {
        console.error('domainsContainer element not found');
        return;
    }
    
    if (domains.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-list fa-3x text-muted mb-3"></i>
                <h5>No Domains in Whitelist</h5>
                <p class="text-muted">Add domains to get started.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
                    <i class="fas fa-plus me-1"></i>Add First Domain
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    domains.forEach((entry, index) => {
        const value = entry.value || entry.domain || 'N/A';
        const type = entry.type || 'domain';
        const addedDate = formatTimestamp(entry.added_date);
        const entryId = entry.id || entry._id || index;
        
        const entryElement = document.createElement('div');
        entryElement.className = 'list-group-item d-flex justify-content-between align-items-center';
        entryElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="form-check me-3">
                    <input class="form-check-input" type="checkbox" value="${entryId}" onchange="toggleDomainSelection('${entryId}')">
                </div>
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-${type === 'domain' ? 'globe' : type === 'ip' ? 'network-wired' : type === 'url' ? 'link' : 'code'} me-2 text-primary"></i>
                        ${value}
                        <span class="badge bg-secondary ms-2">${type}</span>
                        ${entry.priority === 'high' ? '<span class="badge bg-warning ms-1">High</span>' : ''}
                        ${entry.priority === 'critical' ? '<span class="badge bg-danger ms-1">Critical</span>' : ''}
                    </h6>
                    <div class="d-flex align-items-center text-muted">
                        <small class="me-3">
                            <i class="fas fa-user me-1"></i>
                            ${entry.added_by || 'Unknown'}
                        </small>
                        <small title="${formatTimestamp(entry.added_date, true)}">
                            <i class="fas fa-calendar me-1"></i>
                            ${addedDate}
                        </small>
                        ${entry.category ? `
                            <small class="ms-3">
                                <i class="fas fa-tag me-1"></i>
                                ${entry.category}
                            </small>
                        ` : ''}
                    </div>
                    ${entry.notes ? `
                        <div class="mt-1">
                            <small class="text-muted">
                                <i class="fas fa-sticky-note me-1"></i>
                                ${entry.notes}
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div class="btn-group btn-group-sm domain-actions" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="editEntry('${entryId}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteEntry('${entryId}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(entryElement);
    });
}

// âœ… Refresh whitelist
async function refreshWhitelist() {
    try {
        showNotification('info', 'Refreshing whitelist...');
        await loadWhitelist();
        showNotification('success', 'Whitelist refreshed successfully');
    } catch (error) {
        console.error('Error refreshing whitelist:', error);
        showNotification('danger', 'Failed to refresh whitelist: ' + error.message);
    }
}

// âœ… Delete entry
async function deleteEntry(entryId) {
    if (!confirm('Are you sure you want to delete this entry?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/whitelist/${entryId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showNotification('success', 'Entry deleted successfully');
            await refreshWhitelist();
        } else {
            throw new Error(data.error || 'Delete failed');
        }
        
    } catch (error) {
        console.error('Error deleting entry:', error);
        showNotification('danger', 'Failed to delete entry: ' + error.message);
    }
}

// âœ… Edit entry (placeholder)
function editEntry(entryId) {
    showNotification('info', 'Edit functionality coming soon...');
    console.log('Edit entry:', entryId);
}

// âœ… Filter domains
function filterDomains() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceFilter').value;
    
    let filtered = whitelistData;
    
    if (searchInput) {
        filtered = filtered.filter(domain => 
            (domain.value || domain.domain || '').toLowerCase().includes(searchInput) ||
            (domain.notes && domain.notes.toLowerCase().includes(searchInput))
        );
    }
    
    if (sourceFilter) {
        if (sourceFilter === 'manual') {
            filtered = filtered.filter(domain => domain.added_by && domain.added_by !== 'system');
        } else if (sourceFilter === 'system') {
            filtered = filtered.filter(domain => domain.added_by === 'system');
        } else if (sourceFilter === 'imported') {
            filtered = filtered.filter(domain => domain.category === 'imported');
        }
    }
    
    renderDomains(filtered);
}

// âœ… Sort domains
function sortDomains() {
    const sortBy = document.getElementById('sortSelect').value;
    
    let sorted = [...whitelistData];
    
    switch (sortBy) {
        case 'domain':
            sorted.sort((a, b) => (a.value || a.domain || '').localeCompare(b.value || b.domain || ''));
            break;
        case 'added_date':
            sorted.sort((a, b) => new Date(b.added_date || 0) - new Date(a.added_date || 0));
            break;
        case 'added_by':
            sorted.sort((a, b) => (a.added_by || '').localeCompare(b.added_by || ''));
            break;
    }
    
    whitelistData = sorted;
    filterDomains();
}

// âœ… Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('sourceFilter').value = '';
    document.getElementById('sortSelect').value = 'domain';
    renderDomains(whitelistData);
}

// âœ… Selection functions
function toggleDomainSelection(domainId) {
    if (selectedDomains.has(domainId)) {
        selectedDomains.delete(domainId);
    } else {
        selectedDomains.add(domainId);
    }
    updateBulkActions();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]:not(#selectAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll) {
            selectedDomains.add(checkbox.value);
        } else {
            selectedDomains.delete(checkbox.value);
        }
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActionsRow = document.getElementById('bulkActionsRow');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedDomains.size > 0) {
        bulkActionsRow.style.display = 'block';
        selectedCount.textContent = selectedDomains.size;
    } else {
        bulkActionsRow.style.display = 'none';
    }
}

function clearSelection() {
    selectedDomains.clear();
    document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateBulkActions();
}

// âœ… Enhanced Bulk Delete functionality
async function bulkDelete() {
    if (selectedDomains.size === 0) {
        showNotification('warning', 'No domains selected');
        return;
    }
    
    const selectedCount = selectedDomains.size;
    const confirmMessage = `Are you sure you want to delete ${selectedCount} selected domain${selectedCount > 1 ? 's' : ''}?\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        showNotification('info', `Deleting ${selectedCount} selected domains...`);
        
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        // Use Promise.allSettled to handle multiple concurrent requests
        const deletePromises = Array.from(selectedDomains).map(async (entryId) => {
            try {
                const response = await fetch(`/api/whitelist/${entryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    successCount++;
                    return { success: true, entryId };
                } else {
                    throw new Error(data.error || 'Delete failed');
                }
            } catch (error) {
                errorCount++;
                errors.push({ entryId, error: error.message });
                return { success: false, entryId, error: error.message };
            }
        });
        
        // Wait for all delete operations to complete
        await Promise.allSettled(deletePromises);
        
        // Show results
        if (successCount > 0 && errorCount === 0) {
            showNotification('success', `âœ… Successfully deleted ${successCount} domain${successCount > 1 ? 's' : ''}`);
        } else if (successCount > 0 && errorCount > 0) {
            showNotification('warning', `âš ï¸ Partially completed: ${successCount} deleted, ${errorCount} failed`);
            console.warn('Bulk delete errors:', errors);
        } else {
            showNotification('danger', `âŒ Failed to delete any domains. ${errorCount} errors occurred.`);
            console.error('Bulk delete errors:', errors);
        }
        
        // Clear selection and refresh
        clearSelection();
        await refreshWhitelist();
        
    } catch (error) {
        console.error('Error in bulk delete:', error);
        showNotification('danger', 'Bulk delete failed: ' + error.message);
    }
}

function bulkExport() {
    if (selectedDomains.size === 0) {
        showNotification('warning', 'No domains selected');
        return;
    }
    
    try {
        // Get selected domains data
        const selectedData = whitelistData.filter(entry => 
            selectedDomains.has(entry.id || entry._id || entry.domain)
        );
        
        if (selectedData.length === 0) {
            showNotification('warning', 'No valid data found for selected domains');
            return;
        }
        
        // Prepare export data
        const exportData = selectedData.map(entry => ({
            value: entry.value || entry.domain,
            type: entry.type || 'domain',
            category: entry.category,
            priority: entry.priority,
            notes: entry.notes,
            added_by: entry.added_by,
            added_date: entry.added_date
        }));
        
        // Create and download file
        const jsonContent = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `whitelist-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('success', `âœ… Exported ${selectedData.length} domains to JSON file`);
        
    } catch (error) {
        console.error('Error exporting domains:', error);
        showNotification('danger', 'Export failed: ' + error.message);
    }
}

// âœ… Notification helper
function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    
    const formattedMessage = message.replace(/\n/g, '<br>');
    
    notification.innerHTML = `
        <div>
            <strong>${type === 'danger' ? 'âŒ Error' : type === 'success' ? 'âœ… Success' : type === 'warning' ? 'âš ï¸ Warning' : 'â„¹ï¸ Info'}</strong><br>
            ${formattedMessage}
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
    
    console.log(`${type.toUpperCase()}: ${message}`);
}

// âœ… Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Start the clock
    startClock();
    
    // Load whitelist data
    loadWhitelist();
    
    // Handle page visibility change to pause/resume clock
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopClock();
        } else {
            startClock();
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopClock();
    });
});
</script>
{% endblock %}